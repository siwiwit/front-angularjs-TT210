#set( $_ = "$" )
#set( $referencedEntities = $entity.referencedEntityTypes() )## All referenced entities (PK and NON PK)
#set( $tools = $loader.newInstance("Tools") )
#set( $keyValues = $tools.randomKeyAttributesValues($entity))
##
#set( $urlParamValues = "" )
#set( $methodArgumentValues = "" )
#set( $objectKeyDefinition = "" )
#set( $objectKeyDefinitionNull = "" )
##
#set( $i = 0 )
#foreach( $key in $entity.keyAttributes )
##
#set( $urlParamValues = $urlParamValues + "/" + ${keyValues.get($i)} )
##
#if( $i > 0 )
#set( $methodArgumentValues = $methodArgumentValues + ", " )
#end
#set( $methodArgumentValues = $methodArgumentValues + "'" + ${keyValues.get($i)} + "'" )
##
#if( $i > 0 )
#set( $objectKeyDefinition = $objectKeyDefinition + ", " )
#end
#set( $objectKeyDefinition = $objectKeyDefinition + $key.name + ":'" + ${keyValues.get($i)} + "'" )
##
#if( $i > 0 )
#set( $objectKeyDefinitionNull = $objectKeyDefinitionNull + ", " )
#end
#set( $objectKeyDefinitionNull = $objectKeyDefinitionNull + $key.name + ":null" )
##
#set( $i = $i+1 )
#end
'use strict';

/* jasmine specs for controllers go here */

describe('controllers', function(){
  beforeEach(module('${fn.uncapitalize($entity.name)}.module'));
  
  describe('${entity.name}Ctrl', function(){
    var ${entity.name}Ctrl, ${entity.name}, ${_}rootScope, ${_}scope, ${_}routeParams, ${_}httpBackend, ${_}location, MessageHandler, ${_}q, ${_}controller;
	  
    beforeEach(inject(function(${_}injector) {
    	${_}controller = ${_}injector.get('${_}controller');
    	${_}q = ${_}injector.get('${_}q');
    	${_}rootScope = ${_}injector.get('${_}rootScope');
    	${_}scope = ${_}rootScope.${_}new();
    	${_}routeParams = ${_}injector.get('${_}routeParams');
    	${_}httpBackend = ${_}injector.get('${_}httpBackend');
    	${_}location = ${_}injector.get('${_}location');
    	
    	// Messages
    	MessageHandler = {
    		cleanMessage: jasmine.createSpy("cleanMessage"),
    		addSuccess: jasmine.createSpy("addSuccess"),
    		manageError: jasmine.createSpy("manageError"),
    		manageException: jasmine.createSpy("manageException"),
    	};

    	// ${entity.name} service
    	${entity.name} = {
    		getAll: function() {
    			var deferred = ${_}q.defer();
    			deferred.resolve({data:'${fn.uncapitalize($entity.name)}1'});
    			return deferred.promise;
    		}
    	};

		${entity.name}Ctrl = ${_}controller('${entity.name}Ctrl', {
    		'${entity.name}': ${entity.name},
    		'${_}scope': ${_}scope,
    		'${_}routeParams': ${_}routeParams,
    		'${_}http': ${_}httpBackend,
    		'${_}location': ${_}location,
    		'MessageHandler': MessageHandler
    	});
    }));

    afterEach(function() {
    	${_}httpBackend.verifyNoOutstandingExpectation();
    	${_}httpBackend.verifyNoOutstandingRequest();
    });
    
    it('init', function() {
    	${_}rootScope.${_}apply();
    	expect(${_}scope.mode).toBeNull();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}).toBeNull();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}s).toBe('${fn.uncapitalize($entity.name)}1');
    	expect(Object.keys(${_}scope.items).length).toBe(${referencedEntities.size()});
    	expect(MessageHandler.cleanMessage).toHaveBeenCalled();
    });
    
    it('refresh${entity.name}List', function() {
    	// given
    	${entity.name}.getAll = function() {
			var deferred = ${_}q.defer();
			deferred.resolve({data:'${fn.uncapitalize($entity.name)}2'});
			return deferred.promise;
		}
    	
    	// when
    	${_}scope.refresh${entity.name}List();
    	${_}scope.${_}apply();

    	// then
    	${_}rootScope.${_}apply();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}s).toBe('${fn.uncapitalize($entity.name)}2');
    });
    
    it('refresh${entity.name}', function() {
    	// given
    	${entity.name}.get = function(id) {
			var deferred = ${_}q.defer();
			deferred.resolve({data:'${fn.uncapitalize($entity.name)}'+id});
			return deferred.promise;
		}
    	
    	// when
    	${_}scope.refresh${entity.name}(10);
    	${_}scope.${_}apply();
    	
    	// then
    	expect(${_}scope.${fn.uncapitalize($entity.name)}).toBe('${fn.uncapitalize($entity.name)}10');
    });
    /*
    it('goTo${entity.name}List', function() {
    	// given
    	spyOn(${_}scope, "refresh${entity.name}List");
    	spyOn(${_}location, "path");
    	
    	// when
    	${_}scope.goTo${entity.name}List();
    	${_}scope.${_}apply();
    	
    	// then
    	expect(${_}scope.refresh${entity.name}List).toHaveBeenCalled();
    	expect(${_}location.path).toHaveBeenCalledWith('/${fn.uncapitalize($entity.name)}');
    });
    
    it('goTo${entity.name}', function() {
    	// given
    	spyOn(${_}scope, "refresh${entity.name}");
    	spyOn(${_}location, "path");
    	var id = 10;
    	
    	// when
    	${_}scope.goTo${entity.name}(id);
    	${_}scope.${_}apply();
    	
    	// then
    	expect(${_}scope.refresh${entity.name}).toHaveBeenCalledWith(id);
    	expect(${_}location.path).toHaveBeenCalledWith('/${fn.uncapitalize($entity.name)}/'+id);
    });
    */
    it('save : create', function() {
    	// given
    	${_}scope.${fn.uncapitalize($entity.name)} = {${objectKeyDefinition}, name:'${fn.uncapitalize($entity.name)}'};
    	
    	${_}scope.mode = 'create';
    	${entity.name}.create = function() {
			var deferred = ${_}q.defer();
			deferred.resolve({data:'${fn.uncapitalize($entity.name)}Saved'});
			return deferred.promise;
		}
    	
    	// when
    	${_}scope.save();
    	${_}scope.${_}apply();
    	
    	// then
    	expect(MessageHandler.cleanMessage).toHaveBeenCalled();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}).toBe('${fn.uncapitalize($entity.name)}Saved');
    	expect(MessageHandler.addSuccess).toHaveBeenCalledWith('save ok');
    });
    
    it('save : update', function() {
    	// given
    	${_}scope.${fn.uncapitalize($entity.name)} = {${objectKeyDefinition}, name:'${fn.uncapitalize($entity.name)}'};
    	
    	${_}scope.mode = 'update';
    	${entity.name}.update = function() {
			var deferred = ${_}q.defer();
			deferred.resolve({data:'${fn.uncapitalize($entity.name)}Saved'});
			return deferred.promise;
		}
    	
    	// when
    	${_}scope.save();
    	${_}scope.${_}apply();
    	
    	// then
    	expect(MessageHandler.cleanMessage).toHaveBeenCalled();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}).toBe('${fn.uncapitalize($entity.name)}Saved');
    	expect(MessageHandler.addSuccess).toHaveBeenCalledWith('save ok');
    });
    
    it('delete', function() {
    	// given
    	${entity.name}.delete = function() {
			var deferred = ${_}q.defer();
			deferred.resolve(null);
			return deferred.promise;
		}
    	spyOn(${_}scope, "goTo${entity.name}List");
    	
    	// when
    	${_}scope.delete(${methodArgumentValues});
    	${_}scope.${_}apply();
    	
    	// then
    	expect(${_}scope.goTo${entity.name}List).toHaveBeenCalled();
    	expect(MessageHandler.cleanMessage).toHaveBeenCalled();
    });
    /*
    it('init : ${fn.uncapitalize($entity.name)} create page', function() {
    	// given
		location = {
			path: function() {
				return 'http://test/rest/${fn.uncapitalize($entity.name)}/new';
			}
		}
		${entity.name}Ctrl = ${_}controller('${entity.name}Ctrl', {
    		'${entity.name}': ${entity.name},
    		'${_}scope': ${_}scope,
    		'${_}routeParams': ${_}routeParams,
    		'${_}http': ${_}httpBackend,
    		'${_}location': ${_}location,
    		'MessageHandler': MessageHandler
    	});

		// when
		${_}scope.${_}apply();
		
		// then
    	expect(${_}scope.mode).toBeNull();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}).toBeNull();
    	expect(${_}scope.${fn.uncapitalize($entity.name)}s).toBe('${fn.uncapitalize($entity.name)}1');
    	expect(Object.keys(${_}scope.items).length).toBe(0);
    	expect(MessageHandler.cleanMessage).toHaveBeenCalled();
    });
	*/
  });
});